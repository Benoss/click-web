From 0722bd0c07030e18145b7b51e285545f3919f46a Mon Sep 17 00:00:00 2001
From: Fredrik Corneliusson <fredrik.corneliusson@consultant.volvofinans.se>
Date: Mon, 4 Feb 2019 18:25:55 +0100
Subject: [PATCH] Set "selected" on select form field. And only create download
 links if there are any.

---
 click_web/resources/cmd_exec.py          | 16 +++++++++++-----
 click_web/resources/input_fields.py      |  1 +
 click_web/templates/command_form.html.j2 |  9 ++++++---
 3 files changed, 18 insertions(+), 8 deletions(-)

diff --git a/click_web/resources/cmd_exec.py b/click_web/resources/cmd_exec.py
index 114fcd4..c372e58 100644
--- a/click_web/resources/cmd_exec.py
+++ b/click_web/resources/cmd_exec.py
@@ -136,7 +136,7 @@ def _create_result_footer(req_to_args: 'RequestToCommandArgs'):
         here we always allow to generate HTML as long as we have it between CLICK-WEB comments.
         This way the JS frontend can insert it in the correct place in the DOM.
     """
-    to_download = [fi for fi in req_to_args.field_infos if fi.generate_download_link]
+    to_download = [fi for fi in req_to_args.field_infos if fi.generate_download_link and fi.link_name]
     # important yield this block as one string so it pushed to client in one go.
     # so the whole block can be treated as html.
     lines = []
@@ -199,15 +199,21 @@ class RequestToCommandArgs:
                     # TODO: does file upload support multiple keys? In that case support it.
                     args.append(fi.file_path)
                 else:
-                    args.extend(request.form.getlist(fi.key))
+                    arg_value = request.form.getlist(fi.key)
+                    has_values = bool(''.join(arg_value))
+                    # If arg value is empty the field was not filled, and thus optional argument
+                    if has_values:
+                        logger.info(f'arg_value: "{arg_value}"')
+                        args.extend(arg_value)
         return args
 
     def _process_option(self, field_info):
         vals = request.form.getlist(field_info.key)
         if field_info.is_file:
-            # it's a file, append the file path
-            yield field_info.cmd_opt
-            yield field_info.file_path
+            if field_info.link_name:
+                # it's a file, append the file path
+                yield field_info.cmd_opt
+                yield field_info.file_path
         elif vals:
             # opt with value, if option was given multiple times get the values for each.
             no_values = bool(''.join(vals))
diff --git a/click_web/resources/input_fields.py b/click_web/resources/input_fields.py
index 82ac5f9..5e95684 100644
--- a/click_web/resources/input_fields.py
+++ b/click_web/resources/input_fields.py
@@ -95,6 +95,7 @@ class ChoiceInput(BaseInput):
         type_attrs = {}
         type_attrs['type'] = 'option'
         type_attrs['options'] = self.param.type.choices
+        type_attrs['default'] = self.param.default
         type_attrs['click_type'] = 'choice'
         return type_attrs
 
diff --git a/click_web/templates/command_form.html.j2 b/click_web/templates/command_form.html.j2
index 3acbe2b..ce68310 100644
--- a/click_web/templates/command_form.html.j2
+++ b/click_web/templates/command_form.html.j2
@@ -12,8 +12,8 @@
 </head>
 <body>
 <a href="/">Back to index</a>
-<h1>{{ command.name|title }}</h1>
-<div class="command-help">{{ command.help|capitalize }}</div>
+<h1>{{ command.name|striptags|title }}</h1>
+<div class="command-help">{{ command.help|striptags|capitalize }}</div>
 
 <form id="inputform"
       method="post"
@@ -33,7 +33,10 @@
                             {% if field.type == 'option' %}
                                 <select name="{{ field.name }}">
                                     {% for option in field.options %}
-                                        <option value="{{ option }}">{{ option }}</option>
+                                        <option value="{{ option }}"
+                                                {{ 'selected' if field.default == option else '' }}>
+                                            {{ option }}
+                                        </option>
                                     {% endfor %}
                                 </select>
                             {% else %}
-- 
2.15.0.windows.1

